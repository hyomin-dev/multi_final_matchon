<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/mypage/mypage.css}">
</head>
<body>
<div th:replace="~{common/header::header}"></div>

<div id="wrap">
    <h1>마이페이지</h1>
    <img th:src="${profileImageUrl}" alt="프로필 이미지" width="150">
    <form id="profileUploadForm" enctype="multipart/form-data">
        <input type="file" id="profileImageInput" name="profileImage">
        <button type="button" onclick="uploadProfile()">사진 업로드</button>
    </form>

    <div th:switch="${memberRole}">
        <div th:case="'USER'">
            <p>이름: <span th:text="${memberName}"></span></p>
            <p>활동 시간대: <select id="timeSelect"></select></p>
            <p>포지션: <select id="positionSelect"></select></p>
            <p>마이온도: <input type="number" id="temperatureInput" step="0.1" min="30" max="45" th:value="${myTemperature}"> °C</p>
            <p>소속팀: <span th:text="${teamName}"></span></p>
            <button onclick="submitMypage()">수정하기</button>
        </div>
        <div th:case="'HOST'">
            <p>이름: <span th:text="${memberName}"></span></p>
            <label>주최 기관 이름: <input type="text" id="hostNameInput" th:value="${hostName}" placeholder="기관명을 입력해주세요"></label>
            <button type="button" onclick="submitHostName()">등록</button>
            <button type="button" id="scheduleButton">대회 등록하러 가기</button>
        </div>
    </div>
</div>

<div th:replace="~{common/footer::footer}"></div>

<script th:inline="javascript">
    const currentPosition = /*[[${myPosition}]]*/ "";
    const currentTimeType = /*[[${myTimeType}]]*/ "";
    const hostName = /*[[${hostName}]]*/ null;
</script>
<script>
    const positionLabelMap = {
        "GOALKEEPER": "골키퍼", "CENTER_BACK": "센터백", "LEFT_RIGHT_BACK": "풀백",
        "LEFT_RIGHT_WING_BACK": "윙백", "CENTRAL_DEFENSIVE_MIDFIELDER": "수비형 미드필더",
        "CENTRAL_MIDFIELDER": "중앙 미드필더", "CENTRAL_ATTACKING_MIDFIELDER": "공격형 미드필더",
        "LEFT_RIGHT_WING": "윙", "STRIKER_CENTER_FORWARD": "스트라이커",
        "SECOND_STRIKER": "세컨드 스트라이커", "LEFT_RIGHT_WINGER": "윙어"
    };

    const timeLabelMap = {
        "WEEKDAY_MORNING": "평일 오전", "WEEKDAY_AFTERNOON": "평일 오후", "WEEKDAY_EVENING": "평일 저녁",
        "WEEKEND_MORNING": "주말 오전", "WEEKEND_AFTERNOON": "주말 오후", "WEEKEND_EVENING": "주말 저녁"
    };

    document.addEventListener("DOMContentLoaded", () => {
        fetch("/mypage/enums")
            .then(res => res.json())
            .then(data => {
                const positionSelect = document.getElementById("positionSelect");
                const timeSelect = document.getElementById("timeSelect");

                if (positionSelect) {
                    data.positionNames.forEach(pos => {
                        const option = document.createElement("option");
                        option.value = pos;
                        option.text = positionLabelMap[pos] || pos;
                        if (pos === currentPosition.replace(/"/g, '').trim()) {
                            option.selected = true;
                        }
                        positionSelect.appendChild(option);
                    });
                }

                if (timeSelect) {
                    data.timeTypes.forEach(time => {
                        const option = document.createElement("option");
                        option.value = time;
                        option.text = timeLabelMap[time] || time;
                        if (time === currentTimeType.replace(/"/g, '').trim()) {
                            option.selected = true;
                        }
                        timeSelect.appendChild(option);
                    });
                }
            });
    });

    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (const c of cookies) {
            const [k, v] = c.trim().split('=');
            if (k === name) return v;
        }
        return null;
    }

    function submitMypage() {
        const token = getCookie("Authorization");
        if (!token) return alert("로그인이 필요합니다.");

        const temperature = parseFloat(document.getElementById("temperatureInput").value);
        if (temperature < 30) {
            alert("마이온도는 30도 미만으로 수정할 수 없습니다.");
            return;
        }

        const data = {
            positionName: document.getElementById("positionSelect").value,
            timeType: document.getElementById("timeSelect").value,
            temperature: temperature
        };

        fetch("/mypage/update", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token.trim()}`
            },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) {
                alert("수정 완료!");
                location.href = "/mypage?updated=" + new Date().getTime();
            } else {
                res.text().then(msg => alert("오류: " + msg));
            }
        });
    }

    // 주최 기관이 없는 경우 대회 등록 버튼 클릭 방지
    document.addEventListener("DOMContentLoaded", () => {
        const scheduleButton = document.getElementById("scheduleButton");

        if (scheduleButton) {
            scheduleButton.addEventListener("click", () => {
                const hostNameInput = document.getElementById("hostNameInput")?.value.trim();

                if (!hostNameInput || hostNameInput.toLowerCase() === "null") {
                    alert("주최 기관명이 비어 있습니다. 먼저 입력하고 등록 버튼을 눌러 저장하세요.");
                    return;
                }

                // 서버에서 가져온 hostName (DB 저장된 값)
                if (!hostName || hostName.trim().toLowerCase() !== hostNameInput.toLowerCase()) {
                    alert("기관명이 아직 저장되지 않았습니다. 먼저 '등록' 버튼을 눌러 기관명을 저장하세요.");
                    return;
                }

                // 이동
                location.href = "/schedule";
            });
        }
    });

    function uploadProfile() {
        const file = document.getElementById("profileImageInput").files[0];
        if (!file) return alert("파일을 선택해주세요.");
        const formData = new FormData();
        formData.append("profileImage", file);

        fetch("/mypage/uploadProfile", {
            method: "POST",
            body: formData,
            credentials: "include"
        }).then(res => {
            if (res.ok) location.reload();
            else res.text().then(msg => alert("업로드 오류: " + msg));
        });
    }

    function submitHostName() {
        const name = document.getElementById("hostNameInput").value.trim();
        if (!name) return alert("기관명을 입력해주세요.");

        // 서버 중복 체크 후 등록
        fetch(`/mypage/hostName/exist?name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(exists => {
                if (exists) {
                    alert("이미 등록된 기관명입니다. 다른 이름을 입력해주세요.");
                    return;
                }

                fetch("/mypage/hostName", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ hostName: name }),
                    credentials: "include"
                }).then(res => {
                    if (res.ok) location.reload();
                    else res.text().then(msg => alert("등록 오류: " + msg));
                });
            });
    }
</script>

<script th:if="${errorMessage != null}" th:inline="javascript">
    alert([[${errorMessage}]]);
</script>
</body>
</html>
