<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/footer.css}">

</head>
<body>
<div th:replace="~{common/header::header}"></div>
<div id="wrap">
    <h1>마이페이지</h1>


    <img th:src="${profileImageUrl}" alt="프로필 이미지" width="150">
    <form id="profileUploadForm" enctype="multipart/form-data">
        <input type="file" id="profileImageInput" name="profileImage">
        <button type="button" onclick="uploadProfile()">사진 업로드</button>
    </form>

    <div th:switch="${memberRole}">
        <div th:case="'USER'">
            <p>이름: <span th:text="${memberName}"></span></p>
            <p>종목: <span th:text="${sportsName}"></span></p>
            <p>마이온도: <span th:text="${myTemperature}"></span>°C</p>
            <p>소속팀: <span th:text="${teamName != null ? teamName : '팀이 없습니다'}"></span></p>
        </div>

        <div th:case="'HOST'">
            <p>주최자 이름: <span th:text="${memberName}"></span></p>
            <p>종목: <span th:text="${sportsName}"></span></p>
            <label>
                주최 기관 이름:
                <input type="text" id="hostNameInput" name="hostName"
                       th:value="${hostName != null and hostName != '' ? hostName : ''}"
                       placeholder="기관명을 입력해주세요">
            </label>
                <button type="submit" onclick="submitHostName()">등록</button>
            </form>
            <a th:href="@{/event/register}">대회 등록하러 가기</a>
        </div>

        <div th:case="'ADMIN'">
            <a th:href="@{/admin/inquiries}">1:1 문의 내역</a>
            <a th:href="@{/admin/tournaments}">대회 등록 내역</a>
        </div>
    </div>
</div>
<div th:replace="~{common/footer::footer}"></div>

<script>

    function uploadProfile() {
        const input = document.getElementById('profileImageInput');
        const file = input.files[0];
        if (!file) {
            alert("파일을 선택해주세요.");
            return;
        }

        const formData = new FormData();
        formData.append("profileImage", file);

        fetch("/mypage/uploadProfile", {
            method: "POST",
            body: formData,
            credentials: "include" // 쿠키 포함
        })
            .then(res => {
                if (res.ok) {
                    alert("사진이 업로드되었습니다.");
                    location.reload(); // 업로드 후 이미지 반영되게 새로고침
                } else {
                    return res.text().then(msg => { throw new Error(msg); });
                }
            })
            .catch(err => {
                console.error("업로드 오류:", err);
                alert("업로드 실패: " + err.message);
            });
    }

    function submitHostName() {
        const input = document.getElementById("hostNameInput");
        const hostName = input.value.trim();

        if (!hostName) {
            alert("기관명을 입력해주세요.");
            return;
        }

        fetch("/mypage/hostName", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({ hostName }),
            credentials: "include"
        })
            .then(res => {
                if (res.ok) {
                    alert("기관이 등록되었습니다.");
                    location.reload();
                } else {
                    return res.text().then(msg => { throw new Error(msg); });
                }
            })
            .catch(err => {
                console.error("기관명 등록 실패:", err);
                alert("등록 실패: " + err.message);
            });
    }
</script>
</body>
</html>