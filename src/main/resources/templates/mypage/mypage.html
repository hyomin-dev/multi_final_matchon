<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/header.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/footer.css}">
</head>
<body>
<div th:replace="~{common/header::header}"></div>

<div id="wrap">
    <h1>마이페이지</h1>

    <!-- 프로필 이미지 -->
    <img th:src="${profileImageUrl}" alt="프로필 이미지" width="150">
    <form id="profileUploadForm" enctype="multipart/form-data">
        <input type="file" id="profileImageInput" name="profileImage">
        <button type="button" onclick="uploadProfile()">사진 업로드</button>
    </form>

    <div th:switch="${memberRole}">
        <div th:case="'USER'">
            <p>이름: <span th:text="${memberName}"></span></p>

            <!-- 활동 시간대 선택 -->
            <p>활동 시간대:
                <select id="timeSelect"></select>
            </p>

            <!-- 포지션 선택 -->
            <p>포지션:
                <select id="positionSelect"></select>
            </p>

            <!-- 마이온도 수정 -->
            <p>마이온도:
                <input type="number" id="temperatureInput" step="0.1" min="30" max="45"
                       th:value="${myTemperature}" placeholder="예: 36.5"> °C
            </p>

            <p>소속팀: <span th:text="${teamName != null ? teamName : '팀이 없습니다'}"></span></p>

            <button onclick="submitMypage()">수정하기</button>
        </div>

        <div th:case="'HOST'">
            <p>이름: <span th:text="${memberName}"></span></p>
            <label>
                주최 기관 이름:
                <input type="text" id="hostNameInput" name="hostName"
                       th:value="${hostName != null and hostName != '' ? hostName : ''}"
                       placeholder="기관명을 입력해주세요">
            </label>
            <button type="button" onclick="submitHostName()">등록</button>

            <a th:href="@{/schedule}">대회 등록하러 가기</a>
        </div>
    </div>
</div>

<div th:replace="~{common/footer::footer}"></div>

<!-- 드롭다운 라벨 매핑 -->
<script>
    const positionLabelMap = {
        "GOALKEEPER": "골키퍼",
        "CENTER_BACK": "센터백",
        "LEFT_RIGHT_BACK": "풀백",
        "LEFT_RIGHT_WING_BACK": "윙백",
        "CENTRAL_DEFENSIVE_MIDFIELDER": "수비형 미드필더",
        "CENTRAL_MIDFIELDER": "중앙 미드필더",
        "CENTRAL_ATTACKING_MIDFIELDER": "공격형 미드필더",
        "LEFT_RIGHT_WING": "윙",
        "STRIKER_CENTER_FORWARD": "스트라이커",
        "SECOND_STRIKER": "세컨드 스트라이커",
        "LEFT_RIGHT_WINGER": "윙어"
    };

    const timeLabelMap = {
        "WEEKDAY_MORNING": "평일 오전",
        "WEEKDAY_AFTERNOON": "평일 오후",
        "WEEKDAY_EVENING": "평일 저녁",
        "WEEKEND_MORNING": "주말 오전",
        "WEEKEND_AFTERNOON": "주말 오후",
        "WEEKEND_EVENING": "주말 저녁"
    };

    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                return cookie.substring(name.length + 1); // = 뒤부터 끝까지 잘라서 반환
            }
        }
        return null;
    }

    document.addEventListener("DOMContentLoaded", function () {
        fetch("/mypage/enums")
            .then(res => res.json())
            .then(data => {
                const positionSelect = document.getElementById("positionSelect");
                const timeSelect = document.getElementById("timeSelect");

                data.positionNames.forEach(pos => {
                    const option = document.createElement("option");
                    option.value = pos;
                    option.text = positionLabelMap[pos] || pos;
                    positionSelect.appendChild(option);
                });

                data.timeTypes.forEach(time => {
                    const option = document.createElement("option");
                    option.value = time;
                    option.text = timeLabelMap[time] || time;
                    timeSelect.appendChild(option);
                });
            });
    });

    function uploadProfile() {
        const input = document.getElementById('profileImageInput');
        const file = input.files[0];
        if (!file) {
            alert("파일을 선택해주세요.");
            return;
        }

        const formData = new FormData();
        formData.append("profileImage", file);

        fetch("/mypage/uploadProfile", {
            method: "POST",
            body: formData,
            credentials: "include"
        }).then(res => {
            if (res.ok) {
                alert("사진이 업로드되었습니다.");
                location.reload();
            } else {
                return res.text().then(msg => {
                    throw new Error(msg);
                });
            }
        }).catch(err => {
            console.error("업로드 오류:", err);
            alert("업로드 실패: " + err.message);
        });
    }

    function submitHostName() {
        const input = document.getElementById("hostNameInput");
        const hostName = input.value.trim();

        if (!hostName) {
            alert("기관명을 입력해주세요.");
            return;
        }

        fetch("/mypage/hostName", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({ hostName }),
            credentials: "include"
        }).then(res => {
            if (res.ok) {
                alert("기관이 등록되었습니다.");
                location.reload();
            } else {
                return res.text().then(msg => {
                    throw new Error(msg);
                });
            }
        }).catch(err => {
            console.error("기관명 등록 실패:", err);
            alert("등록 실패: " + err.message);
        });
    }

    function submitMypage() {
        const accessToken = getCookie("Authorization");
        console.log("accessToken:", accessToken); // 확인용 로그

        if (!accessToken) {
            alert("로그인 토큰이 없습니다. 다시 로그인해주세요.");
            return;
        }

        const position = document.getElementById("positionSelect").value;
        const time = document.getElementById("timeSelect").value;
        const temperature = document.getElementById("temperatureInput").value;


        fetch("/mypage/update", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": accessToken.startsWith("Bearer ") ? accessToken : `Bearer ${accessToken.trim()}`
            },
            body: JSON.stringify({
                positionName: position,
                timeType: time,
                temperature: temperature
            })
        }).then(res => {
            if (res.ok) {
                alert("수정 완료!");
                location.reload();
            } else {
                res.text().then(msg => alert("오류: " + msg));
            }
        }).catch(err => {
            console.error("요청 실패:", err);
            alert("요청 실패: " + err.message);
        });
    }
</script>
</body>
</html>