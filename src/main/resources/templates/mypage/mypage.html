<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
</head>
<body>
<div th:replace="~{common/header::header}"></div>

<div id="wrap">
    <h1>MY PAGE</h1>

    <img th:src="${profileImageUrl}" alt="프로필 이미지" width="150">
    <form id="profileUploadForm" enctype="multipart/form-data">
        <input type="file" id="profileImageInput" name="profileImage">
        <button type="button" onclick="uploadProfile()">사진 업로드</button>
    </form>

    <div th:switch="${memberRole}">
        <div th:case="'USER'">
            <p>이름: <span th:text="${memberName}"></span></p>
            <p>활동 시간대:
                <select id="timeSelect"></select>
            </p>
            <p>포지션:
                <select id="positionSelect"></select>
            </p>
            <p>마이온도:
                <input type="number" id="temperatureInput" step="0.1" min="30" max="45" th:value="${myTemperature}" placeholder="예: 36.5"> °C
            </p>
            <p>소속팀: <span th:text="${teamName}"></span></p>
            <button onclick="submitMypage()">수정하기</button>
        </div>
        <div th:case="'HOST'">
            <p>이름: <span th:text="${memberName}"></span></p>
            <label>주최 기관 이름:
                <input type="text" id="hostNameInput" name="hostName" th:value="${hostName}" placeholder="기관명을 입력해주세요">
            </label>
            <button type="button" onclick="submitHostName()">등록</button>
            <a th:href="@{/schedule}">대회 등록하러 가기</a>
        </div>
    </div>
</div>

<div th:replace="~{common/footer::footer}"></div>

<script th:inline="javascript">
    const positionLabelMap = {
        "GOALKEEPER": "골키퍼", "CENTER_BACK": "센터백", "LEFT_RIGHT_BACK": "풀백",
        "LEFT_RIGHT_WING_BACK": "윙백", "CENTRAL_DEFENSIVE_MIDFIELDER": "수비형 미드필더",
        "CENTRAL_MIDFIELDER": "중앙 미드필더", "CENTRAL_ATTACKING_MIDFIELDER": "공격형 미드필더",
        "LEFT_RIGHT_WING": "윙", "STRIKER_CENTER_FORWARD": "스트라이커",
        "SECOND_STRIKER": "세컨드 스트라이커", "LEFT_RIGHT_WINGER": "윙어"
    };

    const timeLabelMap = {
        "WEEKDAY_MORNING": "평일 오전", "WEEKDAY_AFTERNOON": "평일 오후", "WEEKDAY_EVENING": "평일 저녁",
        "WEEKEND_MORNING": "주말 오전", "WEEKEND_AFTERNOON": "주말 오후", "WEEKEND_EVENING": "주말 저녁"
    };

    const currentPosition = /*[[${myPosition}]]*/ "";
    const currentTimeType = /*[[${myTimeType}]]*/ "";

    document.addEventListener("DOMContentLoaded", () => {
        fetch("/mypage/enums")
            .then(res => res.json())
            .then(data => {
                const positionSelect = document.getElementById("positionSelect");
                const timeSelect = document.getElementById("timeSelect");

                data.positionNames.forEach(pos => {
                    const option = document.createElement("option");
                    option.value = pos;
                    option.text = positionLabelMap[pos] || pos;
                    if (pos === currentPosition) option.selected = true;
                    positionSelect.appendChild(option);
                });

                data.timeTypes.forEach(time => {
                    const option = document.createElement("option");
                    option.value = time;
                    option.text = timeLabelMap[time] || time;
                    if (time === currentTimeType) option.selected = true;
                    timeSelect.appendChild(option);
                });
            });
    });

    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (const c of cookies) {
            const [k, v] = c.trim().split('=');
            if (k === name) return v;
        }
        return null;
    }

    function submitMypage() {
        const token = getCookie("Authorization");
        if (!token) return alert("로그인이 필요합니다.");

        const data = {
            positionName: document.getElementById("positionSelect").value,
            timeType: document.getElementById("timeSelect").value,
            temperature: document.getElementById("temperatureInput").value
        };

        fetch("/mypage/update", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": token.startsWith("Bearer ") ? token : `Bearer ${token.trim()}`
            },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) {
                alert("수정 완료!");
                location.reload(); // 수정 후 반영되도록 새로고침
            } else {
                res.text().then(msg => alert("오류: " + msg));
            }
        });
    }

    function uploadProfile() {
        const file = document.getElementById("profileImageInput").files[0];
        if (!file) return alert("파일을 선택해주세요.");
        const formData = new FormData();
        formData.append("profileImage", file);

        fetch("/mypage/uploadProfile", {
            method: "POST",
            body: formData,
            credentials: "include"
        }).then(res => {
            if (res.ok) location.reload();
            else res.text().then(msg => alert("오류: " + msg));
        });
    }

    function submitHostName() {
        const name = document.getElementById("hostNameInput").value.trim();
        if (!name) return alert("기관명을 입력해주세요.");
        fetch("/mypage/hostName", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ hostName: name }),
            credentials: "include"
        }).then(res => {
            if (res.ok) location.reload();
            else res.text().then(msg => alert("오류: " + msg));
        });
    }
</script>
</body>
</html>