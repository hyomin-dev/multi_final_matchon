<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/aibot/aichatbot.css}">
</head>
<body>
<div th:fragment="footer">
    <hr class="navy_hr">
    <footer class="footer">team@matchon.com | 02-123-123</footer>

    <sec:authorize access="isAuthenticated()">
        <img src="/img/aichatbot.png" id="chatbot-launcher"
             style="position: fixed; bottom: 30px; right: 20px; width: 80px; cursor: pointer; z-index: 1000;">

        <div id="chatbot-modal" style="display: none; position: fixed; bottom: 120px; right: 30px;
         width: 400px; height: 600px; border-radius: 15px; overflow: hidden;
         box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 9999; background: white; display: flex; flex-direction: column;">
            <div style="background: #333; color: white; padding: 10px; font-weight: bold;
                display: flex; justify-content: space-between; align-items: center; height: 40px; flex-shrink: 0;">
                <span>MatchON 챗봇</span>
                <button id="chatbot-close" style="background: transparent; border: none;
                    color: white; font-size: 18px; cursor: pointer;">✕</button>
            </div>
            <iframe src="/aichat" style="flex: 1; border: none;"></iframe>
        </div>
    </sec:authorize>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const launcher = document.getElementById("chatbot-launcher");
        const modal = document.getElementById("chatbot-modal");
        const closeBtn = document.getElementById("chatbot-close");

        fetch('/auth/check', {
            credentials: 'include'
        }).then(res => {
            if (!res.ok) {
                if (launcher) launcher.remove();
                if (modal) modal.remove();
            }
        });

        if (launcher) {
            launcher.addEventListener("click", function () {
                fetch("/auth/check", {
                    credentials: "include"
                }).then(res => {
                    if (res.ok) {
                        modal.style.display = "block";
                    } else {
                        alert("로그인 후 사용 가능합니다.");
                    }
                });
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener("click", function () {
                modal.style.display = "none";
            });
        }
    });
</script>
<script th:src="@{/js/aibot/aichatbot.js}"></script>
</body>
</html>