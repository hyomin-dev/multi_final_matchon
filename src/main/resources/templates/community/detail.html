<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/community.css}">
</head>
<body class="flex-layout">
<div class="page-wrapper">
    <div th:replace="~{common/header::header}"></div>

    <div class="content-box">
        <div class="post-header" style="position: relative;">
            <h2 th:text="${board.title}" class="post-title">제목</h2>

            <div th:if="${board.member.id == #authentication.principal.member.id}"
                 class="board-delete-button-container">
                <button type="button"
                        class="board-delete-button"
                        th:onclick="'deletePost(' + ${board.id} + ')'">
                    ✖ 삭제
                </button>
            </div>

            <div class="post-meta meta-horizontal">
                <span><strong>작성자:</strong> <span th:text="${board.member.memberName}"></span></span>
                <span><strong>카테고리:</strong> <span th:text="${board.category.displayName}"></span></span>
                <span><strong>작성일:</strong> <span th:text="${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm')}"></span></span>
            </div>
        </div>

        <div class="post-body">
            <div th:utext="${board.content}" class="post-content"></div>

            <div th:if="${board.boardAttachmentEnabled}" class="attachment-box">
                <strong>첨부파일</strong>
                <ul>
                    <li th:each="path, iterStat : ${savedPaths}">
                        <a th:href="@{/community/download-force/{filename}(filename=${path})}"
                           th:text="${originalNames[iterStat.index]}"></a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="post-actions">
            <a th:href="@{/community}" class="back-link"> 목록으로 </a>
        </div>

        <div th:if="${board.member.id == #authentication.principal.member.id}" class="post-actions">
            <a th:href="@{'/community/' + ${board.id} + '/edit'}" class="edit-link">수정하기</a>

        </div>

        <div class="post-actions">
            <a th:href="@{/community}" class="back-link"> 목록으로 </a>
        </div>
    </div>

    <div class="comment-section">
        <h3>댓글</h3>
        <form id="commentForm">
            <textarea id="commentContent" placeholder="댓글을 입력하세요."></textarea>
            <button type="submit">댓글 작성</button>
        </form>

        <ul id="commentList">
            <li th:each="comment : ${comments}" th:attr="data-comment-id=${comment.id}">
                <small>
                    <span th:text="${comment.member.memberName}">작성자</span> |
                    <span th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}">작성일</span>
                    <button type="button"
                            class="btn-comment-delete"
                            th:data-comment-id="${comment.id}"
                            th:data-board-id="${board.id}"
                            th:if="${comment.member.id == #authentication.principal.member.id}">
                        삭제
                    </button>
                </small>
                <p th:text="${comment.content}"></p>
            </li>
        </ul>
    </div>
</div>

<div th:replace="~{common/footer::footer}"></div>

<script>
    function deletePost(boardId) {
        if (!confirm("정말 삭제하시겠습니까?")) return;

        const token = localStorage.getItem("accessToken");

        fetch(`/community/${boardId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        })
            .then(response => {
                if (response.status === 401) {
                    alert("로그인이 필요한 서비스입니다.");
                    window.location.href = "/login";
                } else if (response.ok) {
                    alert("삭제되었습니다.");
                    window.location.href = "/community";
                } else {
                    alert("삭제에 실패했습니다.");
                }
            })
            .catch(error => {
                console.error("삭제 요청 오류:", error);
                alert("오류가 발생했습니다.");
            });
    }

    document.getElementById("commentForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const content = document.getElementById("commentContent").value.trim();
        const boardId = /* 서버에서 렌더링하거나 전역 변수로 사용 */ document.location.pathname.split("/")[2];
        const token = localStorage.getItem("accessToken");

        if (!content) {
            alert("댓글을 입력해주세요.");
            return;
        }

        fetch(`/community/${boardId}/comments`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ content: content })
        })
            .then(res => res.json())
            .then(data => {
                const commentList = document.getElementById("commentList");
                const newComment = document.createElement("li");
                newComment.innerHTML = `
                <small><b>${data.memberName}</b> | ${data.createdDate}
                    <button type="button" class="btn-comment-delete" data-comment-id="${data.commentId}" data-board-id="${boardId}">삭제</button>
                </small>
                <p>${data.content}</p>
            `;
                commentList.prepend(newComment);
                document.getElementById("commentContent").value = "";
            })
            .catch(err => {
                console.error("댓글 등록 오류:", err);
                alert("댓글 등록 실패");
            });
    });

    document.addEventListener("click", function (e) {
        if (e.target.matches(".btn-comment-delete")) {
            const commentId = e.target.dataset.commentId;
            const boardId = e.target.dataset.boardId;
            const token = localStorage.getItem("accessToken");

            if (!confirm("댓글을 삭제하시겠습니까?")) return;

            fetch(`/community/${boardId}/comments/${commentId}`, {
                method: "DELETE",
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => {
                    if (res.ok) {
                        e.target.closest("li").remove();
                    } else {
                        alert("댓글 삭제 실패");
                    }
                });
        }
    });
</script>
</body>
</html>
