<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Matchon - Main</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/main.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/aibot/aichatbot.css}">

    <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
</head>

<body>
<div class="hero">
    <!-- ===== NAVIGATION ===== -->
    <div class="navbar">
        <div>
            <img src="/img/matchon_logo.png" alt="Matchon Logo" class="logo">
        </div>
        <div class="center">
            <a th:href="@{/introduction}">INTRODUCTION</a>
            <a th:href="@{/matchup/board}">MATCHUP</a>
<!--            <a th:href="@{/guest}">GUEST</a>-->
            <a th:href="@{/stadium}">STADIUM</a>
            <a th:href="@{/community}">COMMUNITY</a>
            <a th:href="@{/schedule}">SCHEDULE</a>
            <a th:href="@{/cs}">CS</a>
            <a th:href="@{/team}">TEAM</a>
        </div>
        <div class="icons">
            <img id="chat-icon" src="/img/chat-white.png">
            <img src="/img/bell-white.png">
        </div>
        <div class="auth">
            <a id="btn-login" th:href="@{/login}" class="btn">LOGIN</a>
            <a id="btn-signup" th:href="@{/signup}" class="btn">SIGN UP</a>
            <a id="btn-mypage" th:href="@{/mypage}" class="btn" style="display: none;">MY</a>
            <a id="btn-admin" th:href="@{/admin}" class="btn" style="display: none;">ADMIN</a>
            <a id="btn-logout" href="javascript:logout()" class="btn" style="display: none;">LOGOUT</a>
        </div>
    </div>

    <!-- ===== HERO TEXT ===== -->
    <div class="hero-text">
        <h1>Wanna Match?</h1>
        <h1>You're On!</h1>
        <button th:onclick="|location.href='@{/introduction}'|">GO!</button>
    </div>

    <sec:authorize access="isAuthenticated()">
        <!-- 챗봇 아이콘 -->
        <img src="/img/aichatbot.png" id="chatbot-launcher"
             style="position: fixed; bottom: 30px; right: 20px; width: 80px; cursor: pointer; z-index: 1000;">

        <div id="chatbot-modal" style="display: none; position: fixed; bottom: 120px; right: 30px;
        width: 400px; height: 600px; border-radius: 15px; overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 9999; background: white; display: flex; flex-direction: column;">
            <div style="background: #333; color: white; padding: 10px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center; height: 40px; flex-shrink: 0;">
                <span>MatchON 챗봇</span>
                <button id="chatbot-close" style="background: transparent; border: none;
                color: white; font-size: 18px; cursor: pointer;">✕</button>
            </div>
            <iframe src="/aichat" style="flex: 1; border: none;"></iframe>
        </div>
    </sec:authorize>


    <!-- ===== FOOTER ===== -->
    <footer class="footer">
        team@matchon.com | 02-123-123
    </footer>
</div>

<!-- ===== SCRIPT ===== -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        // 로그인 상태 확인 후 버튼 표시

        const chatImg = document.querySelector("#chat-icon");

        if (chatImg) {
            chatImg.addEventListener("click", () => {
                window.location.href = "/chat/my/rooms"; // 새 창에서 열기
            });
        }

        fetch('/auth/check', {
            method: 'GET',
            credentials: 'include'
        }).then(res => res.json())
            .then(data => {
                const loginBtn = document.getElementById("btn-login");
                const signupBtn = document.getElementById("btn-signup");
                const myBtn = document.getElementById("btn-mypage");
                const adminBtn = document.getElementById("btn-admin");
                const logoutBtn = document.getElementById("btn-logout");

                if (data.role === "ADMIN") {
                    loginBtn.style.display = "none";
                    signupBtn.style.display = "none";
                    adminBtn.style.display = "inline-block";
                    myBtn.style.display = "none";
                    logoutBtn.style.display = "inline-block";
                } else {
                    loginBtn.style.display = "none";
                    signupBtn.style.display = "none";
                    adminBtn.style.display = "none";
                    myBtn.style.display = "inline-block";
                    logoutBtn.style.display = "inline-block";
                }
            }).catch(() => {
            document.getElementById("btn-login").style.display = "inline-block";
            document.getElementById("btn-signup").style.display = "inline-block";
            document.getElementById("btn-mypage").style.display = "none";
            document.getElementById("btn-admin").style.display = "none";
            document.getElementById("btn-logout").style.display = "none";
        });


        // 챗봇 열기/닫기 로직
        const launcher = document.getElementById("chatbot-launcher");
        const modal = document.getElementById("chatbot-modal");
        const closeBtn = document.getElementById("chatbot-close");

        fetch('/auth/check', {
            credentials: 'include'
        }).then(res => {
            if (!res.ok) {
                if (launcher) launcher.remove();
                if (modal) modal.remove();
            }
        });

        if (launcher) {
            launcher.addEventListener("click", function () {
                fetch("/auth/check", {
                    credentials: "include"
                }).then(res => {
                    if (res.ok) {
                        modal.style.display = "block";
                    } else {
                        alert("로그인 후 사용 가능합니다.");
                    }
                });
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener("click", function () {
                modal.style.display = "none";
            });
        }

    });

    function logout() {
        const dfMessenger = document.querySelector("df-messenger");
        if (dfMessenger) dfMessenger.remove();

        fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include'
        }).then(() => {
            alert("로그아웃 되었습니다.");
            window.location.href = "/main";
        });
    }

</script>
<script th:src="@{/js/aibot/aichatbot.js}"></script>
</body>
</html>
